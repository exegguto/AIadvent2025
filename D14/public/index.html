<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cursor-like Code Executor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
        }

        .app {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 300px;
            height: 100vh;
            background: #161b22;
            border-right: 1px solid #30363d;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #30363d;
        }

        .sidebar-header h1 {
            font-size: 18px;
            font-weight: 600;
            color: #f0f6fc;
        }

        .sidebar-header p {
            font-size: 12px;
            color: #8b949e;
            margin-top: 4px;
        }

        .projects-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        .projects-header {
            padding: 15px 20px;
            border-bottom: 1px solid #30363d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .projects-header h2 {
            font-size: 14px;
            font-weight: 600;
            color: #f0f6fc;
        }

        .new-project-btn {
            background: #238636;
            color: #f0f6fc;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .new-project-btn:hover {
            background: #2ea043;
        }

        .projects-list {
            flex: 1;
            overflow-y: scroll;
            overflow-x: hidden;
            padding: 10px 0;
            min-height: 0;
            max-height: calc(100vh - 200px);
            height: calc(100vh - 200px);
        }

        /* Custom scrollbar styles */
        .projects-list::-webkit-scrollbar {
            width: 8px;
        }

        .projects-list::-webkit-scrollbar-track {
            background: #21262d;
            border-radius: 4px;
        }

        .projects-list::-webkit-scrollbar-thumb {
            background: #484f58;
            border-radius: 4px;
        }

        .projects-list::-webkit-scrollbar-thumb:hover {
            background: #5a6169;
        }

        /* Notification styles */
        .notification {
            display: none; /* Hide all notifications */
            position: fixed;
            top: 20px;
            right: 20px;
            background: #238636;
            color: #f0f6fc;
            padding: 12px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            max-width: 400px;
            font-size: 14px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            display: none; /* Keep hidden even when show class is applied */
            transform: translateX(0);
        }

        .notification.error {
            background: #da3633;
        }

        .notification.warning {
            background: #d29922;
        }

        .notification.info {
            background: #1f6feb;
        }

        .notification-content {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .notification-icon {
            font-size: 16px;
        }

        .notification-message {
            flex: 1;
        }

        .notification-close {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 16px;
            padding: 0;
            margin-left: 8px;
        }

        /* Execution progress indicator */
        .execution-progress {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .execution-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 8px 0;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .execution-status.running {
            background: rgba(52, 152, 219, 0.2);
        }

        .execution-status.success {
            background: rgba(46, 204, 113, 0.2);
        }

        .execution-status.error {
            background: rgba(231, 76, 60, 0.2);
        }

        .project-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.2s;
            border-left: 3px solid transparent;
        }

        .project-item:hover {
            background: #21262d;
        }

        .project-item.active {
            background: #21262d;
            border-left-color: #1f6feb;
        }

        .project-name {
            font-size: 14px;
            font-weight: 500;
            color: #f0f6fc;
            margin-bottom: 4px;
        }

        .project-info {
            font-size: 12px;
            color: #8b949e;
        }

        .project-language {
            display: inline-block;
            background: #30363d;
            padding: 2px 6px;
            border-radius: 3px;
            margin-right: 8px;
        }

        .project-files {
            margin-top: 10px;
            border-top: 1px solid #30363d;
            padding-top: 10px;
        }

        .file-tree {
            font-size: 12px;
        }

        .file-item {
            padding: 4px 8px;
            margin: 2px 0;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.2s;
        }

        .file-item:hover {
            background: #21262d;
        }

        .file-item.active {
            background: #1f6feb;
            color: #f0f6fc;
        }

        .file-icon {
            width: 14px;
            height: 14px;
            opacity: 0.7;
        }

        .file-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-type-badge {
            font-size: 10px;
            padding: 1px 4px;
            border-radius: 2px;
            background: #30363d;
        }

        .file-type-code .file-type-badge {
            background: #238636;
        }

        .file-type-test .file-type-badge {
            background: #da3633;
        }

        .file-type-config .file-type-badge {
            background: #f0883e;
        }

        .file-type-other .file-type-badge {
            background: #8b949e;
        }

        .project-actions {
            margin-top: 10px;
            display: flex;
            gap: 8px;
        }

        .project-action-btn {
            background: #30363d;
            color: #8b949e;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .project-action-btn:hover {
            background: #484f58;
            color: #f0f6fc;
        }

        .project-action-btn.danger:hover {
            background: #da3633;
        }
        
        .project-action-btn.prompt-btn {
            background: #0d47a1;
            color: #e3f2fd;
        }
        
        .project-action-btn.prompt-btn:hover {
            background: #1565c0;
            color: #ffffff;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #0d1117;
            height: 100vh;
            overflow: hidden;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #30363d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h2 {
            font-size: 16px;
            font-weight: 600;
            color: #f0f6fc;
        }

        .model-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .model-selector label {
            font-size: 12px;
            color: #8b949e;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .model-selector select {
            background: #21262d;
            border: 1px solid #30363d;
            color: #f0f6fc;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
        }

        .prompt-btn {
            background: #21262d;
            border: 1px solid #30363d;
            color: #8b949e;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .prompt-btn:hover {
            background: #30363d;
            color: #f0f6fc;
            border-color: #484f58;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            min-height: 0;
            max-height: calc(100vh - 200px);
        }

        .message {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            max-width: 80%;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .message.user {
            background: #21262d;
            margin-left: auto;
        }

        .message.assistant {
            background: #161b22;
            border: 1px solid #30363d;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 12px;
            color: #8b949e;
        }

        .message-role {
            font-weight: 600;
            text-transform: uppercase;
        }

        .message-content {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .code-block {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            margin: 10px 0;
            overflow: hidden;
        }

        .code-header {
            background: #21262d;
            padding: 8px 12px;
            font-size: 12px;
            color: #8b949e;
            border-bottom: 1px solid #30363d;
        }

        .code-content {
            padding: 12px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.5;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .execution-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
        }

        .execution-success {
            background: #0c5323;
            border: 1px solid #238636;
        }

        .execution-error {
            background: #5a1e1e;
            border: 1px solid #da3633;
        }

        .chat-input-container {
            padding: 20px;
            border-top: 1px solid #30363d;
            background: #0d1117;
            flex-shrink: 0;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 12px;
            color: #f0f6fc;
            font-family: inherit;
            font-size: 14px;
            resize: none;
            min-height: 44px;
            max-height: 200px;
        }

        .chat-input:focus {
            outline: none;
            border-color: #1f6feb;
        }

        .send-btn {
            background: #238636;
            color: #f0f6fc;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
            white-space: nowrap;
        }

        .send-btn:hover {
            background: #2ea043;
        }

        .send-btn:disabled {
            background: #30363d;
            color: #8b949e;
            cursor: not-allowed;
        }

        .execute-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            font-size: 12px;
            color: #8b949e;
        }

        .execute-toggle input[type="checkbox"] {
            accent-color: #238636;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 24px;
            width: 400px;
            max-width: 90vw;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: #f0f6fc;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            color: #f0f6fc;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 8px 12px;
            color: #f0f6fc;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #1f6feb;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: background 0.2s;
        }

        .btn-primary {
            background: #238636;
            color: #f0f6fc;
        }

        .btn-primary:hover {
            background: #2ea043;
        }

        .btn-secondary {
            background: #30363d;
            color: #f0f6fc;
        }

        .btn-secondary:hover {
            background: #484f58;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #30363d;
            border-radius: 50%;
            border-top-color: #1f6feb;
            animation: spin 1s ease-in-out infinite;
            flex-shrink: 0;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #8b949e;
            text-align: center;
        }

        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: #f0f6fc;
        }

        .empty-state p {
            font-size: 14px;
            margin-bottom: 20px;
        }

        .file-viewer {
            max-height: 400px;
            overflow-y: auto;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            margin-top: 10px;
            display: flex;
            flex-direction: column;
        }

        .file-viewer-header {
            background: #21262d;
            padding: 8px 12px;
            border-bottom: 1px solid #30363d;
            font-size: 12px;
            color: #8b949e;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-viewer-content {
            padding: 12px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-y: auto;
            flex: 1;
            min-height: 200px;
        }

        .chat-history-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .history-btn {
            background: #30363d;
            color: #8b949e;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .history-btn:hover {
            background: #484f58;
            color: #f0f6fc;
        }

        .history-btn.danger:hover {
            background: #da3633;
        }

        .prompt-description {
            color: #8b949e;
            font-size: 14px;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .prompt-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .prompt-actions .btn {
            font-size: 12px;
            padding: 6px 12px;
        }

        /* Compare Chats Modal Styles */
        .compare-section {
            margin-bottom: 20px;
        }

        .compare-section h4 {
            margin-bottom: 10px;
            color: #f0f6fc;
        }

        .compare-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .compare-input-group {
            display: flex;
            flex-direction: column;
        }

        .compare-input-group label {
            margin-bottom: 5px;
            color: #f0f6fc;
            font-weight: 500;
        }

        .compare-input-group select {
            padding: 8px 12px;
            border: 1px solid #30363d;
            border-radius: 4px;
            background: #0d1117;
            color: #f0f6fc;
            margin-bottom: 10px;
        }

        .chat-preview {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 4px;
            padding: 10px;
            min-height: 60px;
            font-size: 12px;
            color: #8b949e;
            overflow-y: auto;
            max-height: 120px;
        }

        .chat-preview.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #484f58;
        }

        .analysis-input {
            margin-bottom: 20px;
        }

        .analysis-input label {
            display: block;
            margin-bottom: 5px;
            color: #f0f6fc;
            font-weight: 500;
        }

        .analysis-input textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #30363d;
            border-radius: 4px;
            background: #0d1117;
            color: #f0f6fc;
            resize: vertical;
            font-family: inherit;
        }

        .compare-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .comparison-result {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
        }

        .comparison-content {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 4px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.5;
        }

        .comparison-loading {
            text-align: center;
            padding: 20px;
            color: #8b949e;
        }

        .comparison-loading .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #30363d;
            border-top: 2px solid #1f6feb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>Cursor-like</h1>
                <p>AI Code Executor</p>
            </div>
            
            <div class="projects-section">
                <div class="projects-header">
                    <h2>Projects</h2>
                    <button class="new-project-btn" onclick="showNewProjectModal()">+ New</button>
                </div>
                
                <div class="projects-list" id="projectsList">
                    <div class="empty-state">
                        <h3>No projects yet</h3>
                        <p>Create your first project to get started</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="chat-container">
                <div class="chat-header">
                    <h2 id="currentProjectName">Select a project to start coding</h2>
                    <div class="header-controls">
                        <div class="model-selector">
                            <label for="modelSelect">Model:</label>
                            <select id="modelSelect">
                                <option value="gpt-4o-mini">GPT-4o mini</option>
                                <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                            </select>
                        </div>

                    </div>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <div class="empty-state">
                        <h3>Welcome to Cursor-like</h3>
                        <p>Select a project from the sidebar to start coding with AI</p>
                        </div>
                    </div>
                
                <div class="chat-history-controls" id="chatHistoryControls" style="display: none;">
                    <button class="history-btn" onclick="showCompareChatsModal()">Compare Chats</button>
                    <button class="history-btn" onclick="clearChatHistory()">Clear Chat History</button>
                    <button class="history-btn" onclick="exportChatHistory()">Export History</button>
                    <button class="history-btn" onclick="importChatHistory()">Import History</button>
                </div>

                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <textarea 
                            id="chatInput" 
                            class="chat-input" 
                            placeholder="Describe what you want to build..."
                            rows="1"
                        ></textarea>
                        <button id="sendBtn" class="send-btn" onclick="sendMessage()">Send</button>
                    </div>
                    <div class="execute-toggle">
                        <input type="checkbox" id="executeToggle">
                        <label for="executeToggle">Execute code automatically</label>
                    </div>
                </div>
                    </div>
                </div>
            </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <!-- New Project Modal -->
    <div class="modal" id="newProjectModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Project</h3>
                    </div>
            <form id="newProjectForm">
                <div class="form-group">
                    <label for="projectName">Project Name</label>
                    <input type="text" id="projectName" required>
                    </div>
                <div class="form-group">
                    <label for="projectLanguage">Language</label>
                    <select id="projectLanguage" required>
                        <option value="">Select language</option>
                        <option value="python">Python</option>
                        <option value="javascript">JavaScript</option>
                        <option value="typescript">TypeScript</option>
                        <option value="java">Java</option>
                        <option value="go">Go</option>
                        <option value="rust">Rust</option>
                    </select>
                    </div>
                <div class="form-group">
                    <label for="projectDescription">Description (optional)</label>
                    <textarea id="projectDescription" rows="3"></textarea>
                    </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideNewProjectModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Project</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Compare Chats Modal -->
    <div class="modal" id="compareChatsModal">
        <div class="modal-content" style="width: 800px; max-width: 90vw;">
            <div class="modal-header">
                <h3>Сравнение двух диалогов</h3>
                <button class="close-btn" onclick="hideCompareChatsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="compare-section">
                    <h4>Выберите диалоги для сравнения</h4>
                    <div class="compare-inputs">
                        <div class="compare-input-group">
                            <label for="chat1Select">Первый диалог (текущий):</label>
                            <select id="chat1Select" onchange="loadChatPreview(1)">
                                <option value="">Загрузка...</option>
                            </select>
                            <div id="chat1Preview" class="chat-preview"></div>
                        </div>
                        <div class="compare-input-group">
                            <label for="chat2Select">Второй диалог:</label>
                            <select id="chat2Select" onchange="loadChatPreview(2)">
                                <option value="">Выберите диалог для сравнения...</option>
                            </select>
                            <div id="chat2Preview" class="chat-preview"></div>
                        </div>
                    </div>
                </div>
                
                <div class="compare-section">
                    <h4>Запрос на анализ</h4>
                    <div class="analysis-input">
                        <label for="analysisPrompt">Что вы хотите проанализировать? (необязательно)</label>
                        <textarea id="analysisPrompt" rows="3" placeholder="например: Сравните качество генерации кода, проанализируйте полноту ответов, оцените подходы к решению...">Сравните качество ответов, генерации кода и подходы к решению между этими двумя диалогами. Сосредоточьтесь на:
1. Качестве и полноте кода
2. Ясности и полезности ответов
3. Подходе к решению проблем
4. Различиях в стратегиях реализации</textarea>
                    </div>
                </div>
                
                <div class="compare-actions">
                    <button class="btn btn-primary" onclick="compareChatSessions()">Сравнить диалоги</button>
                    <button class="btn btn-secondary" onclick="hideCompareChatsModal()">Отмена</button>
                </div>
                
                <div id="comparisonResult" class="comparison-result" style="display: none;">
                    <h4>Анализ сравнения</h4>
                    <div id="comparisonContent" class="comparison-content"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- File Viewer Modal -->
    <div class="modal" id="fileViewerModal">
        <div class="modal-content" style="width: 600px; max-width: 90vw;">
            <div class="modal-header">
                <h3 id="fileViewerTitle">File Viewer</h3>
            </div>
            <div id="fileViewerContent">
                <div class="file-viewer">
                    <div class="file-viewer-header">
                        <span id="fileViewerPath">Loading...</span>
                        <span id="fileViewerType">Loading...</span>
                    </div>
                    <div class="file-viewer-content" id="fileViewerText">
                        Loading file content...
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="hideFileViewerModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- System Prompt Modal -->
    <div class="modal" id="promptModal">
        <div class="modal-content" style="width: 800px; max-width: 90vw; max-height: 80vh;">
            <div class="modal-header">
                <h3 id="promptModalTitle">Edit System Prompt</h3>
            </div>
            <div class="modal-body">
                <p class="prompt-description">
                    Customize the system prompt that guides the AI assistant. This prompt defines how the AI should behave and what commands it can understand.
                </p>
                <div class="form-group">
                    <label for="systemPrompt">System Prompt:</label>
                    <textarea 
                        id="systemPrompt" 
                        rows="20" 
                        placeholder="Enter your custom system prompt..."
                        style="font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 12px; line-height: 1.4;"
                    ></textarea>
                </div>
                <div class="prompt-actions">
                    <button class="btn btn-secondary" onclick="resetPrompt()">Reset to Default</button>
                    <button class="btn btn-secondary" onclick="loadPromptTemplate()">Load Template</button>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="hidePromptModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="savePrompt()">Save Prompt</button>
            </div>
        </div>
    </div>

    <script>
        let currentProjectId = null;
        let currentSessionId = null;
        let chatHistory = new Map(); // projectId -> messages[]
        let currentFileViewer = null;

        // Notification system
        function showNotification(message, type = 'info', duration = 5000) {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const icon = type === 'error' ? '❌' : type === 'warning' ? '⚠️' : type === 'success' ? '✅' : 'ℹ️';
            
            notification.innerHTML = `
                <div class="notification-content">
                    <span class="notification-icon">${icon}</span>
                    <span class="notification-message">${message}</span>
                    <button class="notification-close" onclick="this.parentElement.parentElement.remove()">×</button>
                </div>
            `;
            
            container.appendChild(notification);
            
            // Show notification
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // Auto-hide after duration
            if (duration > 0) {
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 300);
                }, duration);
            }
        }

        // Agent execution tracking
        function trackAgentExecution(command, status = 'started', details = null) {
            const messages = {
                'started': `🤖 Агент выполняет команду: ${command}`,
                'completed': `✅ Команда выполнена: ${command}`,
                'failed': `❌ Ошибка выполнения: ${command}`,
                'testing': `🧪 Агент запускает тесты...`,
                'testing_completed': `✅ Тесты выполнены успешно`,
                'testing_failed': `❌ Тесты не прошли`,
                'file_created': `📁 Файл создан агентом`,
                'file_updated': `📝 Файл обновлен агентом`,
                'docker_started': `🐳 Docker контейнер запущен`,
                'docker_completed': `✅ Docker выполнение завершено`,
                'execution_running': `⚡ Выполняется код...`,
                'execution_output': `📤 Вывод выполнения:`,
                'test_running': `🧪 Выполняются тесты...`,
                'test_output': `📊 Результаты тестов:`
            };
            
            let message = messages[status] || `🤖 Агент: ${command}`;
            
            // Add details if provided
            if (details) {
                if (status === 'execution_output' && details.output) {
                    const outputPreview = details.output.length > 100 ? 
                        details.output.substring(0, 100) + '...' : 
                        details.output;
                    message += `\n\n${outputPreview}`;
                } else if (status === 'test_output' && details.results) {
                    if (details.passed !== undefined && details.failed !== undefined && details.total !== undefined) {
                        message += `\n\n✅ ${details.passed}/${details.total} тестов прошли`;
                        if (details.failed > 0) {
                            message += `\n❌ ${details.failed} тестов не прошли`;
                        }
                    } else {
                        const passed = details.results.filter(r => r.success).length;
                        const total = details.results.length;
                        message += `\n\n✅ ${passed}/${total} тестов прошли`;
                        if (details.results.some(r => !r.success)) {
                            message += `\n❌ ${total - passed} тестов не прошли`;
                        }
                    }
                } else if (details.duration) {
                    message += ` (${details.duration}ms)`;
                }
            }
            
            const type = status.includes('failed') ? 'error' : 
                        status.includes('completed') ? 'success' : 
                        status.includes('warning') ? 'warning' : 'info';
            
            showNotification(message, type, status.includes('completed') ? 5000 : 0);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadProjects();
            setupChatInput();
            loadChatHistory();
        });

        // Chat History Management
        function loadChatHistory() {
            try {
                const saved = localStorage.getItem('cursor_chat_history');
                console.log('Loading chat history from localStorage:', saved);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    chatHistory = new Map(Object.entries(parsed));
                    console.log('Loaded chat history:', chatHistory);
                } else {
                    console.log('No saved chat history found');
                }
            } catch (error) {
                console.error('Failed to load chat history:', error);
            }
        }

        function saveChatHistory() {
            try {
                const obj = Object.fromEntries(chatHistory);
                localStorage.setItem('cursor_chat_history', JSON.stringify(obj));
            } catch (error) {
                console.error('Failed to save chat history:', error);
            }
        }

        function addMessageToHistory(projectId, message) {
            if (!chatHistory.has(projectId)) {
                chatHistory.set(projectId, []);
            }
            
            // Check if this is a replacement for a loading message
            const history = chatHistory.get(projectId);
            const lastMessage = history[history.length - 1];
            
            // If the last message is a loading message (has "Processing..." content), replace it
            if (lastMessage && lastMessage.content && 
                (lastMessage.content.includes('Processing...') || 
                 lastMessage.content.includes('<div class="loading"></div>'))) {
                history[history.length - 1] = message;
            } else {
                history.push(message);
            }
            
            saveChatHistory();
        }

        function getProjectHistory(projectId) {
            const history = chatHistory.get(projectId) || [];
            console.log(`Getting history for project ${projectId}:`, history);
            console.log('All chat history keys:', Array.from(chatHistory.keys()));
            return history;
        }

        function clearProjectHistory(projectId) {
            if (confirm('Are you sure you want to clear the chat history for this project?')) {
                chatHistory.delete(projectId);
                saveChatHistory();
                if (currentProjectId === projectId) {
                    document.getElementById('chatMessages').innerHTML = `
                        <div class="empty-state">
                            <h3>Ready to code</h3>
                            <p>Start describing what you want to build</p>
                        </div>
                    `;
                }
                loadProjects(); // Refresh the display
            }
        }

        function clearChatHistory() {
            if (confirm('Are you sure you want to clear the current chat history?')) {
                chatHistory.delete(currentProjectId);
                saveChatHistory();
                document.getElementById('chatMessages').innerHTML = `
                    <div class="empty-state">
                        <h3>Ready to code</h3>
                        <p>Start describing what you want to build</p>
                    </div>
                `;
            }
        }

        function exportChatHistory() {
            if (!currentProjectId) return;
            
            const history = getProjectHistory(currentProjectId);
            const dataStr = JSON.stringify(history, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `chat-history-${currentProjectId}.json`;
            link.click();
        }

        function importChatHistory() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const history = JSON.parse(e.target.result);
                            if (Array.isArray(history)) {
                                chatHistory.set(currentProjectId, history);
                                saveChatHistory();
                                displayChatHistory();
                                alert('Chat history imported successfully!');
                            } else {
                                alert('Invalid file format');
                            }
                        } catch (error) {
                            alert('Failed to parse file: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function displayChatHistory() {
            if (!currentProjectId) {
                console.log('No current project ID');
                return;
            }
            
            console.log('Displaying chat history for project:', currentProjectId);
            const history = getProjectHistory(currentProjectId);
            console.log('History:', history);
            
            const chatMessages = document.getElementById('chatMessages');
            
            if (history.length === 0) {
                console.log('No history found, showing empty state');
                chatMessages.innerHTML = `
                    <div class="empty-state">
                        <h3>Ready to code</h3>
                        <p>Start describing what you want to build</p>
                    </div>
                `;
                return;
            }

            console.log('Displaying', history.length, 'messages');
            chatMessages.innerHTML = '';
            history.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${message.role}`;
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <span class="message-role">${message.role}</span>
                        <span class="message-time">${new Date(message.timestamp).toLocaleTimeString()}</span>
                    </div>
                    <div class="message-content">${formatMessageContent(message.content)}</div>
                `;
                chatMessages.appendChild(messageDiv);
            });
            
            // Scroll to bottom with smooth animation
            setTimeout(() => {
                chatMessages.scrollTo({
                    top: chatMessages.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }

        // Project Management
        async function loadProjects() {
            try {
                const response = await fetch('/api/projects');
                const data = await response.json();
                
                if (data.success) {
                    displayProjects(data.data);
                }
            } catch (error) {
                console.error('Failed to load projects:', error);
            }
        }

        function displayProjects(projects) {
            console.log('Displaying projects:', projects);
            console.log('Current project ID:', currentProjectId);
            
            const projectsList = document.getElementById('projectsList');
            
            if (projects.length === 0) {
                projectsList.innerHTML = `
                    <div class="empty-state">
                        <h3>No projects yet</h3>
                        <p>Create your first project to get started</p>
                    </div>
                `;
                return;
            }

            projectsList.innerHTML = projects.map(project => {
                const isActive = project.id === currentProjectId;
                console.log(`Project ${project.id} active: ${isActive}, files: ${project.files.length}`);
                
                return `
                    <div class="project-item ${isActive ? 'active' : ''}" 
                         data-project-id="${project.id}"
                         onclick="selectProject('${project.id}')">
                        <div class="project-name">${project.name}</div>
                        <div class="project-info">
                            <span class="project-language">${project.language}</span>
                            <span>${project.files.length} files</span>
                        </div>
                        ${isActive ? `
                            <div class="project-files">
                                <div class="file-tree">
                                    ${project.files.map(file => `
                                        <div class="file-item file-type-${file.type}" onclick="event.stopPropagation(); viewFile('${project.id}', '${file.name}')">
                                            <span class="file-icon">📄</span>
                                            <span class="file-name">${file.name}</span>
                                            <span class="file-type-badge">${file.type}</span>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="project-actions">
                                    <button class="project-action-btn prompt-btn" onclick="event.stopPropagation(); showPromptModal('${project.id}')" title="Edit System Prompt">
                                        ⚙️ Prompt
                                    </button>
                                    <button class="project-action-btn" onclick="event.stopPropagation(); clearProjectHistory('${project.id}')">
                                        Clear History
                                    </button>
                                    <button class="project-action-btn danger" onclick="event.stopPropagation(); deleteProject('${project.id}')">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            // Force scroll update
            setTimeout(() => {
                const projectsList = document.getElementById('projectsList');
                if (projectsList) {
                    projectsList.style.overflowY = 'auto';
                    projectsList.scrollTop = 0;
                    console.log('Projects list scroll properties:', {
                        scrollHeight: projectsList.scrollHeight,
                        clientHeight: projectsList.clientHeight,
                        scrollTop: projectsList.scrollTop,
                        overflowY: getComputedStyle(projectsList).overflowY
                    });
                }
            }, 100);
        }

        function selectProject(projectId) {
            currentProjectId = projectId;
            currentSessionId = `session-${projectId}-${Date.now()}`;
            loadProjectDetails(projectId);
            loadProjects(); // Перезагружаем проекты для обновления отображения
            displayChatHistory();
            
            // Show chat history controls
            document.getElementById('chatHistoryControls').style.display = 'block';
        }

        function viewFile(projectId, filename) {
            console.log('Viewing file:', projectId, filename);
            fetch(`/api/projects/${projectId}/files/${encodeURIComponent(filename)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load file');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('File data received:', data);
                    
                    if (!data.success) {
                        throw new Error(data.error || 'Failed to load file');
                    }
                    
                    const fileData = data.data;
                    document.getElementById('fileViewerTitle').textContent = filename;
                    document.getElementById('fileViewerPath').textContent = fileData.path || filename;
                    document.getElementById('fileViewerType').textContent = fileData.type || 'unknown';
                    
                    // Format content based on file type
                    let content = fileData.content;
                    if (filename.endsWith('.json')) {
                        try {
                            content = JSON.stringify(JSON.parse(content), null, 2);
                        } catch (e) {
                            // Keep original content if not valid JSON
                        }
                    }
                    
                    console.log('Setting content:', content);
                    document.getElementById('fileViewerText').textContent = content;
                    document.getElementById('fileViewerModal').style.display = 'block';
                    currentFileViewer = { projectId, filename };
                })
                .catch(error => {
                    console.error('Error loading file:', error);
                    alert('Failed to load file: ' + error.message);
                });
        }

        function hideFileViewerModal() {
            document.getElementById('fileViewerModal').style.display = 'none';
            currentFileViewer = null;
        }

        function deleteProject(projectId) {
            if (confirm('Are you sure you want to delete this project? This action cannot be undone.')) {
                fetch(`/api/projects/${projectId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to delete project');
                    }
                    return response.json();
                })
                .then(data => {
                    // Remove from chat history
                    chatHistory.delete(projectId);
                    saveChatHistory();
                    
                    // If this was the current project, clear the chat
                    if (currentProjectId === projectId) {
                        currentProjectId = null;
                        currentSessionId = null;
                        document.getElementById('chatMessages').innerHTML = `
                            <div class="empty-state">
                                <h3>Select a project</h3>
                                <p>Choose a project from the sidebar to start coding</p>
                            </div>
                        `;
                        document.getElementById('chatHistoryControls').style.display = 'none';
                    }
                    
                    loadProjects();
                })
                .catch(error => {
                    console.error('Error deleting project:', error);
                    alert('Failed to delete project: ' + error.message);
                });
            }
        }

        async function loadProjectDetails(projectId) {
            try {
                const response = await fetch(`/api/projects/${projectId}`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('currentProjectName').textContent = data.data.name;
                    
                    // Update file tree with project files
                    updateFileTree(projectId, data.data.files);
                }
            } catch (error) {
                console.error('Failed to load project details:', error);
            }
        }

        function updateFileTree(projectId, files) {
            // Find the project element and update its file tree
            const projectElement = document.querySelector(`[data-project-id="${projectId}"]`);
            if (projectElement) {
                const fileTreeElement = projectElement.querySelector('.file-tree');
                if (fileTreeElement) {
                    fileTreeElement.innerHTML = files.map(file => `
                        <div class="file-item file-type-${file.type}" onclick="event.stopPropagation(); viewFile('${projectId}', '${file.name}')">
                            <span class="file-icon">📄</span>
                            <span class="file-name">${file.name}</span>
                            <span class="file-type-badge">${file.type}</span>
                        </div>
                    `).join('');
                }
            }
        }

        // Modal Management
        function showNewProjectModal() {
            document.getElementById('newProjectModal').classList.add('show');
        }

        function hideNewProjectModal() {
            document.getElementById('newProjectModal').classList.remove('show');
            document.getElementById('newProjectForm').reset();
        }

        document.getElementById('newProjectForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('projectName').value,
                language: document.getElementById('projectLanguage').value,
                description: document.getElementById('projectDescription').value,
            };

            try {
                const response = await fetch('/api/projects', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData),
                });

                const data = await response.json();
                
                if (data.success) {
                    hideNewProjectModal();
                    loadProjects();
                    selectProject(data.data.id);
                } else {
                    alert('Failed to create project: ' + data.error);
                }
            } catch (error) {
                console.error('Failed to create project:', error);
                alert('Failed to create project');
            }
        });

        // Chat Management
        function setupChatInput() {
        const chatInput = document.getElementById('chatInput');
            
        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 200) + 'px';
        });

        chatInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        }

        async function sendMessage() {
            if (!currentProjectId) {
                alert('Please select a project first');
                return;
            }

            const message = document.getElementById('chatInput').value.trim();
            if (!message) return;

            const model = document.getElementById('modelSelect').value;
            const shouldExecute = document.getElementById('executeToggle').checked;

            // Track agent execution start (disabled)
            // trackAgentExecution(message, 'started');
            
            // Track agent execution if needed (disabled)
            // if (shouldExecute) {
            //     trackAgentExecution('Выполнение кода', 'docker_started');
            // }

            // Check for specific commands that trigger agent execution (disabled)
            // const lowerMessage = message.toLowerCase();
            // if (lowerMessage.includes('запусти тесты') || lowerMessage.includes('run tests') || lowerMessage.includes('выполни тесты')) {
            //     trackAgentExecution('Запуск тестов', 'testing');
            //     
            //     // Add delayed notifications for test execution
            //     if (shouldExecute) {
            //         setTimeout(() => {
            //             trackAgentExecution('Docker контейнер', 'docker_started');
            //         }, 1000);
            //         
            //         setTimeout(() => {
            //             trackAgentExecution('Выполнение тестов', 'test_running');
            //         }, 2000);
            //     }
            // } else if (lowerMessage.includes('создай файл') || lowerMessage.includes('create file')) {
            //     trackAgentExecution('Создание файла', 'file_created');
            // } else if (lowerMessage.includes('измени файл') || lowerMessage.includes('edit file')) {
            //     trackAgentExecution('Редактирование файла', 'file_updated');
            // }

            // Clear input
            document.getElementById('chatInput').value = '';
            document.getElementById('chatInput').style.height = 'auto';

            // Add user message to chat
            addMessageToChat('user', message);

            // Show loading
            const loadingId = addMessageToChat('assistant', '<div class="loading"></div> Processing...');

            try {
                // Get custom system prompt for the current project
                const customPrompt = loadCustomPrompt(currentProjectId);
                console.log('Using custom prompt for project:', currentProjectId, customPrompt ? 'YES' : 'NO');
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message,
                        sessionId: currentSessionId,
                        projectId: currentProjectId,
                        shouldExecute,
                        model,
                        systemPrompt: customPrompt || undefined,
                    }),
                });

                const data = await response.json();
                
                if (data.success) {
                    // Replace loading message with actual response
                    let fullContent = data.message.content;
                    
                    // Add execution results to the message if any
                    if (data.executions && data.executions.length > 0) {
                        fullContent += '\n\n## 📊 Результаты выполнения\n\n';
                        
                        data.executions.forEach((exec, index) => {
                            const status = exec.result.success ? '✅' : '❌';
                            const duration = exec.duration;
                            
                            fullContent += `### Выполнение ${index + 1} ${status}\n`;
                            fullContent += `**Время выполнения:** ${duration}ms\n`;
                            fullContent += `**Язык:** ${exec.language}\n\n`;
                            
                            if (exec.result.output) {
                                fullContent += '**Вывод:**\n';
                                fullContent += '```\n';
                                fullContent += exec.result.output;
                                fullContent += '\n```\n\n';
                            }
                            
                            if (exec.result.error) {
                                fullContent += '**Ошибка:**\n';
                                fullContent += '```\n';
                                fullContent += exec.result.error;
                                fullContent += '\n```\n\n';
                            }
                        });
                    }
                    
                    replaceMessage(loadingId, 'assistant', fullContent, data.message.codeBlocks, data.executions);
                    
                    // Track completion of agent execution with details (disabled)
                    // if (shouldExecute && data.executions && data.executions.length > 0) {
                    //     const totalDuration = data.executions.reduce((sum, exec) => sum + exec.duration, 0);
                    //     
                    //     // Show Docker container start notification
                    //     trackAgentExecution('Docker контейнер', 'docker_started');
                    //     
                    //     // Show execution running notification
                    //     trackAgentExecution('Выполнение кода', 'execution_running');
                    //     
                    //     // Show completion with duration
                    //     trackAgentExecution('Выполнение кода', 'docker_completed', { duration: totalDuration });
                    //     
                    //     // Show detailed execution results
                    //     data.executions.forEach((exec, index) => {
                    //         if (exec.result.output) {
                    //             trackAgentExecution('Результат выполнения', 'execution_output', { 
                    //                 output: exec.result.output,
                    //                 success: exec.result.success,
                    //                 duration: exec.duration
                    //             });
                    //         }
                    //         
                    //         if (exec.result.error) {
                    //             trackAgentExecution('Ошибка выполнения', 'failed', { 
                    //                 error: exec.result.error,
                    //                 duration: exec.duration
                    //             });
                    //         }
                    //     });
                    // }
                    
                    // Check for test execution results
                    if (data.executions && data.executions.length > 0) {
                        const testExecutions = data.executions.filter(exec => 
                            exec.result.output.toLowerCase().includes('test') || 
                            exec.result.output.toLowerCase().includes('unittest') ||
                            exec.result.output.toLowerCase().includes('pytest') ||
                            exec.result.output.toLowerCase().includes('assert') ||
                            exec.result.output.toLowerCase().includes('passed') ||
                            exec.result.output.toLowerCase().includes('failed')
                        );
                        
                        // Test execution notifications (disabled)
                        // if (testExecutions.length > 0) {
                        //     const allPassed = testExecutions.every(exec => exec.result.success);
                        //     const totalDuration = testExecutions.reduce((sum, exec) => sum + exec.duration, 0);
                        //     
                        //     // Show test completion with detailed results
                        //     trackAgentExecution('Тесты', allPassed ? 'testing_completed' : 'testing_failed', { 
                        //         duration: totalDuration 
                        //     });
                        //     
                        //     // Show detailed test results
                        //     testExecutions.forEach((exec, index) => {
                        //         if (exec.result.output) {
                        //             // Parse test results to show pass/fail count
                        //             const output = exec.result.output;
                        //             const passedTests = (output.match(/passed|PASSED|✓|✅/g) || []).length;
                        //             const failedTests = (output.match(/failed|FAILED|✗|❌/g) || []).length;
                        //             const totalTests = passedTests + failedTests;
                        //             
                        //             trackAgentExecution('Результаты тестов', 'test_output', { 
                        //                 results: [exec],
                        //                 output: exec.result.output,
                        //                 passed: passedTests,
                        //                 failed: failedTests,
                        //                 total: totalTests
                        //             });
                        //         }
                        //     });
                        // }
                    }
                    
                    // Update project files if new files were generated
                    if (data.message.codeBlocks && data.message.codeBlocks.length > 0) {
                        // trackAgentExecution('Файлы', 'file_created'); // Disabled
                        setTimeout(() => {
                            loadProjects(); // Refresh the file tree
                        }, 500);
                    }
                } else {
                    // trackAgentExecution('Ошибка', 'failed'); // Disabled
                    replaceMessage(loadingId, 'assistant', 'Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to send message:', error);
                // trackAgentExecution('Ошибка сети', 'failed'); // Disabled
                replaceMessage(loadingId, 'assistant', 'Error: Failed to send message');
            }
        }

        function addMessageToChat(role, content) {
            const chatMessages = document.getElementById('chatMessages');
            
            // Remove empty state if present
            const emptyState = chatMessages.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            const messageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            const message = document.createElement('div');
            message.className = `message ${role}`;
            message.id = messageId;
            
            const timestamp = new Date().toLocaleTimeString();
            message.innerHTML = `
                <div class="message-header">
                    <span class="message-role">${role}</span>
                    <span class="message-time">${timestamp}</span>
                            </div>
                <div class="message-content">${content}</div>
            `;

            chatMessages.appendChild(message);
            
            // Scroll to bottom with smooth animation
            setTimeout(() => {
                chatMessages.scrollTo({
                    top: chatMessages.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
            
            // Save to history if we have a current project
            if (currentProjectId) {
                addMessageToHistory(currentProjectId, {
                    role,
                    content,
                    timestamp: new Date().toISOString()
                });
            }
            
            return messageId;
        }

        function replaceMessage(messageId, role, content, codeBlocks = [], executions = []) {
            const message = document.getElementById(messageId);
            if (!message) return;

            let fullContent = content;

            // Add code blocks
            if (codeBlocks && codeBlocks.length > 0) {
                fullContent += '\n\n';
                codeBlocks.forEach(block => {
                    fullContent += `\n\`\`\`${block.language}${block.filename ? ':' + block.filename : ''}\n${block.code}\n\`\`\`\n`;
                });
            }

            // Add execution results
            if (executions && executions.length > 0) {
                fullContent += '\n\n**Execution Results:**\n';
                executions.forEach(execution => {
                    const resultClass = execution.result.success ? 'execution-success' : 'execution-error';
                    const resultIcon = execution.result.success ? '✅' : '❌';
                    fullContent += `\n${resultIcon} ${execution.language}:\n`;
                    fullContent += `<div class="${resultClass}">`;
                    if (execution.result.output) {
                        fullContent += `Output: ${execution.result.output}\n`;
                    }
                    if (execution.result.error) {
                        fullContent += `Error: ${execution.result.error}\n`;
                    }
                    fullContent += `</div>\n`;
                });
            }

            const timestamp = new Date().toLocaleTimeString();
            message.innerHTML = `
                <div class="message-header">
                    <span class="message-role">${role}</span>
                    <span class="message-time">${timestamp}</span>
                        </div>
                <div class="message-content">${formatMessageContent(fullContent)}</div>
            `;

            // Update the message in history (replace the loading message)
            if (currentProjectId) {
                const history = getProjectHistory(currentProjectId);
                const lastMessage = history[history.length - 1];
                
                // Replace the last message if it's a loading message
                if (lastMessage && lastMessage.content && lastMessage.content.includes('Processing...')) {
                    history[history.length - 1] = {
                        role,
                        content: fullContent,
                        timestamp: new Date().toISOString()
                    };
                    saveChatHistory();
                }
            }

            // Update project files if new files were generated
            if (codeBlocks && codeBlocks.length > 0) {
            setTimeout(() => {
                    loadProjects(); // Refresh the file tree
                }, 500);
            }
        }

        function formatMessageContent(content) {
            // Convert markdown code blocks to HTML
            content = content.replace(/```(\w+)(?::([^\n]+))?\n([\s\S]*?)```/g, (match, language, filename, code) => {
                return `
                    <div class="code-block">
                        <div class="code-header">${language}${filename ? ' - ' + filename : ''}</div>
                        <div class="code-content">${code}</div>
                    </div>
                `;
            });

            // Convert line breaks to <br>
            content = content.replace(/\n/g, '<br>');
            
            return content;
        }

        // Close modal when clicking outside
        document.getElementById('newProjectModal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideNewProjectModal();
            }
        });

        document.getElementById('fileViewerModal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideFileViewerModal();
            }
        });

        document.getElementById('promptModal').addEventListener('click', function(e) {
            if (e.target === this) {
                hidePromptModal();
            }
        });

        // System Prompt Management
        const DEFAULT_SYSTEM_PROMPT = `Ты - AI помощник для разработки, похожий на Cursor IDE. Твоя задача - помогать пользователю в разработке, выполняя команды и управляя проектом.

ОСНОВНЫЕ ПРИНЦИПЫ:
1. Генерируй чистый, читаемый код
2. Всегда добавляй тесты для критической функциональности
3. Используй современные практики и паттерны
4. Объясняй логику работы кода
5. Предлагай улучшения и альтернативы

КОМАНДЫ И ОПЕРАЦИИ:

📁 УПРАВЛЕНИЕ ФАЙЛАМИ:
- "создай файл [имя]" → создание нового файла с кодом
- "создай [функция/класс/модуль]" → создание файла с указанной функциональностью
- "добавь файл [имя]" → добавление нового файла в проект
- "удали файл [имя]" → удаление файла из проекта
- "переименуй [старое_имя] в [новое_имя]" → переименование файла

📝 РЕДАКТИРОВАНИЕ КОДА:
- "измени [файл]" → редактирование существующего файла
- "улучши [функция/код]" → улучшение существующего кода
- "добавь [функциональность] в [файл]" → добавление функциональности
- "исправь [ошибка/проблема]" → исправление ошибок
- "рефакторинг [файл]" → рефакторинг кода

🧪 ВЫПОЛНЕНИЕ ТЕСТОВ:
- "запусти тесты" → выполнение всех тестов в проекте
- "run tests" → выполнение тестов
- "тестируй [файл/функция]" → тестирование конкретного файла или функции
- "проверь код" → выполнение тестов и анализ результатов
- "запусти [файл]" → выполнение конкретного файла

🔍 АНАЛИЗ И ДИАГНОСТИКА:
- "покажи структуру проекта" → отображение структуры файлов
- "найди ошибки в [файл]" → поиск ошибок в коде
- "оптимизируй [файл]" → оптимизация производительности
- "проверь качество кода" → анализ качества кода

📦 УПРАВЛЕНИЕ ЗАВИСИМОСТЯМИ:
- "добавь зависимость [пакет]" → добавление новой зависимости
- "обнови зависимости" → обновление зависимостей
- "покажи зависимости" → отображение списка зависимостей

ФОРМАТ КОДА:
\`\`\`language:filename
код_здесь
\`\`\`

ПОДДЕРЖИВАЕМЫЕ ЯЗЫКИ: python, javascript, typescript, java, go, rust

ПРИМЕРЫ ЗАПРОСОВ:
- "Создай функцию для вычисления факториала" → создание файла с функцией и тестами
- "Запусти тесты для calculate_pi" → выполнение тестов конкретной функции
- "Улучши функцию calculate_pi" → улучшение существующего кода
- "Добавь валидацию в main.py" → добавление валидации в существующий файл
- "Удали ненужные файлы" → удаление неиспользуемых файлов
- "Покажи структуру проекта" → отображение всех файлов проекта

ОТОБРАЖЕНИЕ КОДА:
- Показывай код в контексте объяснения, а не только в конце
- Используй markdown для форматирования
- Вставляй код блоки в соответствующих местах повествования
- Объясняй каждую часть кода по мере его показа

БЕЗОПАСНОСТЬ:
- Не используй опасные команды
- Валидируй входные данные
- Обрабатывай ошибки
- Проверяй существование файлов перед операциями`;

        function showPromptModal(projectId = null) {
            const modal = document.getElementById('promptModal');
            const textarea = document.getElementById('systemPrompt');
            const title = document.getElementById('promptModalTitle');
            
            // Use provided projectId or currentProjectId
            const targetProjectId = projectId || currentProjectId;
            
            // Update modal title
            if (targetProjectId) {
                // Try to get project name
                const projectElement = document.querySelector(`[data-project-id="${targetProjectId}"]`);
                const projectName = projectElement ? projectElement.querySelector('.project-name').textContent : 'Project';
                title.textContent = `Edit System Prompt - ${projectName}`;
            } else {
                title.textContent = 'Edit System Prompt - Global';
            }
            
            // Load current prompt for the specific project or default
            const promptKey = targetProjectId ? `cursor_system_prompt_${targetProjectId}` : 'cursor_system_prompt_global';
            const currentPrompt = localStorage.getItem(promptKey) || DEFAULT_SYSTEM_PROMPT;
            textarea.value = currentPrompt;
            
            // Store the target project ID for saving
            modal.dataset.targetProjectId = targetProjectId;
            
            modal.style.display = 'flex';
        }

        function hidePromptModal() {
            document.getElementById('promptModal').style.display = 'none';
        }

        function savePrompt() {
            const textarea = document.getElementById('systemPrompt');
            const prompt = textarea.value.trim();
            const modal = document.getElementById('promptModal');
            
            if (prompt) {
                // Get the target project ID from modal data
                const targetProjectId = modal.dataset.targetProjectId;
                
                // Save prompt for the specific project
                const promptKey = targetProjectId ? `cursor_system_prompt_${targetProjectId}` : 'cursor_system_prompt_global';
                localStorage.setItem(promptKey, prompt);
                console.log('System prompt saved for project:', targetProjectId, prompt);
                hidePromptModal();
                
                // Show success message
                const projectName = targetProjectId ? `for project` : 'globally';
                const message = addMessageToChat('system', `System prompt updated ${projectName}! The AI will now use your custom prompt.`);
                setTimeout(() => {
                    const msgElement = document.getElementById(message);
                    if (msgElement) {
                        msgElement.style.opacity = '0.7';
                    }
                }, 2000);
            } else {
                alert('Please enter a valid system prompt');
            }
        }

        function resetPrompt() {
            const modal = document.getElementById('promptModal');
            const targetProjectId = modal.dataset.targetProjectId;
            const projectName = targetProjectId ? `for this project` : 'to default';
            
            if (confirm(`Are you sure you want to reset the system prompt ${projectName}?`)) {
                document.getElementById('systemPrompt').value = DEFAULT_SYSTEM_PROMPT;
            }
        }

        function loadPromptTemplate() {
            const template = `Ты - AI помощник для разработки. Твоя задача - помогать пользователю в разработке.

ОСНОВНЫЕ ПРИНЦИПЫ:
1. Генерируй чистый, читаемый код
2. Всегда добавляй тесты
3. Используй современные практики
4. Объясняй логику работы кода

КОМАНДЫ:
- "создай [файл/функция]" → создание файлов
- "запусти тесты" → выполнение тестов
- "улучши [код]" → улучшение кода
- "исправь [ошибка]" → исправление ошибок

ФОРМАТ КОДА:
\`\`\`language:filename
код_здесь
\`\`\`

ОТОБРАЖЕНИЕ КОДА:
- Показывай код в контексте объяснения
- Используй markdown для форматирования
- Вставляй код блоки в соответствующих местах повествования`;
            
            document.getElementById('systemPrompt').value = template;
        }

        // Load custom prompt for specific project
        function loadCustomPrompt(projectId) {
            const promptKey = projectId ? `cursor_system_prompt_${projectId}` : 'cursor_system_prompt_global';
            const customPrompt = localStorage.getItem(promptKey);
            if (customPrompt) {
                console.log('Loaded custom system prompt for project:', projectId);
                return customPrompt;
            }
            return null;
        }

        // Compare Chats Functions
        function showCompareChatsModal() {
            const modal = document.getElementById('compareChatsModal');
            loadAvailableChatSessions();
            modal.style.display = 'flex';
        }

        function hideCompareChatsModal() {
            document.getElementById('compareChatsModal').style.display = 'none';
            document.getElementById('comparisonResult').style.display = 'none';
        }

        function loadAvailableChatSessions() {
            const chat1Select = document.getElementById('chat1Select');
            const chat2Select = document.getElementById('chat2Select');
            
            // Clear existing options
            chat1Select.innerHTML = '<option value="">Загрузка...</option>';
            chat2Select.innerHTML = '<option value="">Выберите диалог для сравнения...</option>';
            
            // Get projects from API instead of localStorage
            fetch('/api/projects')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const projects = data.data;
                        console.log('Loaded projects for comparison:', projects);
                        
                        // Filter projects that have chat history
                        const projectsWithHistory = projects.filter(project => {
                            const history = getProjectHistory(project.id);
                            const hasHistory = history && history.length > 0;
                            console.log(`Project ${project.name} (${project.id}) has history:`, hasHistory, history?.length || 0);
                            return hasHistory;
                        });
                        
                        console.log('Projects with history:', projectsWithHistory);
                        
                        if (projectsWithHistory.length === 0) {
                            chat1Select.innerHTML = '<option value="">Нет диалогов для сравнения</option>';
                            chat2Select.innerHTML = '<option value="">Нет диалогов для сравнения</option>';
                            return;
                        }
                        
                        // Auto-select current project as first option
                        if (currentProjectId) {
                            const currentProject = projectsWithHistory.find(p => p.id === currentProjectId);
                            if (currentProject) {
                                const history = getProjectHistory(currentProjectId);
                                const label = `${currentProject.name} (${history.length} сообщений)`;
                                
                                chat1Select.innerHTML = `<option value="${currentProjectId}">${label}</option>`;
                                loadChatPreview(1); // Load preview for current project
                            }
                        }
                        
                        // Add all projects to second select (excluding current if it's selected)
                        projectsWithHistory.forEach(project => {
                            if (project.id !== currentProjectId) {
                                const history = getProjectHistory(project.id);
                                const option = document.createElement('option');
                                const label = `${project.name} (${history.length} сообщений)`;
                                option.textContent = label;
                                option.value = project.id;
                                chat2Select.appendChild(option);
                            }
                        });
                        
                        // If no current project is selected, add all to first select too
                        if (!currentProjectId || !projectsWithHistory.find(p => p.id === currentProjectId)) {
                            chat1Select.innerHTML = '<option value="">Выберите первый диалог...</option>';
                            projectsWithHistory.forEach(project => {
                                const history = getProjectHistory(project.id);
                                const option = document.createElement('option');
                                const label = `${project.name} (${history.length} сообщений)`;
                                option.textContent = label;
                                option.value = project.id;
                                chat1Select.appendChild(option);
                            });
                        }
                    } else {
                        console.error('Failed to load projects:', data.error);
                        chat1Select.innerHTML = '<option value="">Ошибка загрузки проектов</option>';
                        chat2Select.innerHTML = '<option value="">Ошибка загрузки проектов</option>';
                    }
                })
                .catch(error => {
                    console.error('Error loading projects:', error);
                    chat1Select.innerHTML = '<option value="">Ошибка загрузки проектов</option>';
                    chat2Select.innerHTML = '<option value="">Ошибка загрузки проектов</option>';
                });
        }

        function loadChatPreview(chatNumber) {
            const select = document.getElementById(`chat${chatNumber}Select`);
            const preview = document.getElementById(`chat${chatNumber}Preview`);
            const projectId = select.value;
            
            if (!projectId) {
                preview.innerHTML = '<div class="empty">Диалог не выбран</div>';
                preview.className = 'chat-preview empty';
                return;
            }
            
            const history = getProjectHistory(projectId);
            if (!history || history.length === 0) {
                preview.innerHTML = '<div class="empty">В этом диалоге нет сообщений</div>';
                preview.className = 'chat-preview empty';
                return;
            }
            
            // Show preview of first few messages
            const previewText = history.slice(0, 3).map(msg => {
                const role = msg.role === 'user' ? '👤' : '🤖';
                const content = msg.content.substring(0, 100);
                return `${role} ${content}${msg.content.length > 100 ? '...' : ''}`;
            }).join('\n\n');
            
            preview.innerHTML = previewText;
            preview.className = 'chat-preview';
        }

        async function compareChatSessions() {
            const chat1Id = document.getElementById('chat1Select').value;
            const chat2Id = document.getElementById('chat2Select').value;
            const analysisPrompt = document.getElementById('analysisPrompt').value;
            
            if (!chat1Id || !chat2Id) {
                alert('Пожалуйста, выберите оба диалога для сравнения');
                return;
            }
            
            if (chat1Id === chat2Id) {
                alert('Пожалуйста, выберите разные диалоги для сравнения');
                return;
            }
            
            const resultDiv = document.getElementById('comparisonResult');
            const contentDiv = document.getElementById('comparisonContent');
            
            // Show loading
            resultDiv.style.display = 'block';
            contentDiv.innerHTML = '<div class="comparison-loading"><span class="spinner"></span>Анализируем диалоги...</div>';
            
            try {
                // Get chat histories (limit to last 10 messages each)
                const history1 = getProjectHistory(chat1Id).slice(-10);
                const history2 = getProjectHistory(chat2Id).slice(-10);
                
                if (!history1 || !history2) {
                    throw new Error('Не удалось загрузить истории диалогов');
                }
                
                // Get project names from API
                const projectsResponse = await fetch('/api/projects');
                const projectsData = await projectsResponse.json();
                const projects = projectsData.success ? projectsData.data : [];
                const project1 = projects.find(p => p.id === chat1Id);
                const project2 = projects.find(p => p.id === chat2Id);
                
                // Format chat histories for analysis with length limit
                const formatChatHistory = (history, projectName) => {
                    return history.map(msg => {
                        const role = msg.role === 'user' ? 'Пользователь' : 'Ассистент';
                        // Limit content length to prevent message too long error
                        const content = msg.content.length > 500 ? 
                            msg.content.substring(0, 500) + '...' : 
                            msg.content;
                        return `[${role}]: ${content}`;
                    }).join('\n\n');
                };
                
                const chat1Text = formatChatHistory(history1, project1?.name || 'Диалог 1');
                const chat2Text = formatChatHistory(history2, project2?.name || 'Диалог 2');
                
                // Create analysis request with length limit
                const baseRequest = `Пожалуйста, проанализируйте и сравните эти два диалога:

ДИАЛОГ 1 (${project1?.name || 'Диалог 1'}):
${chat1Text}

ДИАЛОГ 2 (${project2?.name || 'Диалог 2'}):
${chat2Text}

${analysisPrompt || 'Пожалуйста, предоставьте комплексное сравнение этих диалогов, сосредоточившись на качестве кода, полноте ответов, подходе к решению проблем и общей эффективности.'}

Пожалуйста, предоставьте ваш анализ в четком, структурированном формате с конкретными примерами из обеих бесед.`;

                // Limit request length to prevent validation error
                const request = baseRequest.length > 8000 ? 
                    baseRequest.substring(0, 8000) + '\n\n[Содержимое обрезано для предотвращения ошибки длины]' : 
                    baseRequest;

                // Check message length before sending
                if (request.length > 10000) {
                    throw new Error(`Сообщение слишком длинное (${request.length} символов). Максимум 10000 символов.`);
                }

                console.log(`Sending comparison request (${request.length} characters)`);

                // Send to LLM for analysis
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: request,
                        sessionId: `comparison-${Date.now()}`,
                        projectId: chat1Id, // Use first project as context
                        shouldExecute: false,
                        model: 'gpt-4o-mini'
                    }),
                });

                const data = await response.json();
                
                if (data.success) {
                    contentDiv.innerHTML = data.message.content;
                } else {
                    throw new Error(data.error || 'Не удалось проанализировать диалоги');
                }
                
            } catch (error) {
                console.error('Comparison failed:', error);
                contentDiv.innerHTML = `<div class="error">Ошибка: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
